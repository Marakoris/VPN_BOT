{% extends "base.html" %}
{% block title %}–û–ø–ª–∞—Ç–∞ - NoBorder VPN{% endblock %}

{% block content %}
<h1 class="page-title">–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏</h1>

{% if sub.active %}
<div class="card" style="padding:14px 20px;margin-bottom:16px">
    <div style="font-size:14px;color:var(--text-secondary)">
        –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ <span style="color:var(--success);font-weight:500">{{ sub.expiry_date }}</span>
        {% if sub.days_remaining is not none %}
        ({{ sub.days_remaining }} –¥–Ω.)
        {% endif %}
    </div>
</div>
{% endif %}

<div x-data="{
    selectedPlan: {{ request.query_params.get('months', '0') | int }},
    system: 'kassa',
    loading: false,
    plans: [{% for p in plans %}{ months: {{ p.months }}, days: {{ p.days }}, price: {{ p.price }}, name: '{{ p.name }}', per_month: {{ p.per_month }} }{% if not loop.last %},{% endif %}{% endfor %}],
    get selectedPrice() { let p = this.plans.find(p => p.months === this.selectedPlan); return p ? p.price : 0; },
    get selectedDays() { let p = this.plans.find(p => p.months === this.selectedPlan); return p ? p.days : 0; }
}">

    <!-- Plan Selection -->
    <div class="section-header" style="margin-top:0">
        <span class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</span>
    </div>

    <div class="plans-grid">
        {% for plan in plans %}
        <div class="plan-card {% if loop.index == 2 %}popular{% endif %}"
             :class="{ 'selected': selectedPlan === {{ plan.months }} }"
             @click="selectedPlan = {{ plan.months }}">
            <div class="plan-months">{{ plan.months }} –º–µ—Å.</div>
            <div class="plan-price">{{ plan.price }}‚ÇΩ</div>
            <div class="plan-per-month">{{ plan.per_month }}‚ÇΩ/–º–µ—Å</div>
        </div>
        {% endfor %}
    </div>

    <!-- Payment System -->
    <template x-if="selectedPlan > 0">
        <div>
            <div class="section-header">
                <span class="section-title">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</span>
            </div>

            <div class="payment-method" :class="{ 'selected': system === 'kassa' }" @click="system = 'kassa'">
                <div class="payment-method-icon">üí≥</div>
                <div>
                    <div class="payment-method-name">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</div>
                    <div class="payment-method-desc">Visa, MasterCard, –ú–ò–†</div>
                </div>
            </div>

            <div class="payment-method" :class="{ 'selected': system === 'cryptobot' }" @click="system = 'cryptobot'">
                <div class="payment-method-icon">‚Çø</div>
                <div>
                    <div class="payment-method-name">CryptoBot</div>
                    <div class="payment-method-desc">USDT, BTC, TON</div>
                </div>
            </div>

            <!-- Pay Button -->
            <button class="btn btn-primary" style="margin-top:20px"
                    :disabled="loading"
                    @click="
                        loading = true;
                        fetch('/api/v1/payment/create', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({amount: selectedPrice, payment_system: system, months: selectedPlan})
                        })
                        .then(r => r.json())
                        .then(d => {
                            loading = false;
                            if(d.success && d.payment_url) {
                                window.location.href = d.payment_url;
                            } else {
                                showToast(d.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞', true);
                            }
                        })
                        .catch(() => { loading = false; showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', true); })
                    ">
                <span x-show="!loading">–û–ø–ª–∞—Ç–∏—Ç—å <span x-text="selectedPrice + '‚ÇΩ'"></span></span>
                <span x-show="loading">–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...</span>
            </button>
        </div>
    </template>
</div>

<!-- Payment History -->
{% if payments %}
<div class="section-header">
    <span class="section-title">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</span>
</div>

{% for p in payments %}
<div class="card" style="padding:14px 20px">
    <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
            <div style="font-weight:500">{{ p.amount }}‚ÇΩ</div>
            <div style="font-size:12px;color:var(--text-secondary)">{{ p.payment_system }}</div>
        </div>
        <div style="font-size:13px;color:var(--text-muted)">{{ p.date or '' }}</div>
    </div>
</div>
{% endfor %}
{% endif %}
{% endblock %}
